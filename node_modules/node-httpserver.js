var fs = require('fs');
var url = require('url');

function httpserver(publicDirectory) {
	this.publicDirectory = publicDirectory;
	this.getFuncs = {};
	this.postFuncs = {};
	this.onrequest = this.onreq.bind(this);
}

httpserver.prototype.onreq = function(req, res) {
	if(req.method == "GET"){
		var getName = decodeURIComponent(url.parse(req.url).pathname);
		if(getName in this.getFuncs){
			this.getFuncs[getName](req, res);
			return;
		}
	
		var pathname = getName.substring(1);
		if(pathname.length < this.publicDirectory.length || pathname.substring(0, this.publicDirectory.length) != this.publicDirectory)
			pathname = this.publicDirectory + "/" + pathname;
		if(pathname == this.publicDirectory + "/") pathname = this.publicDirectory + "/index.html";
		
		console.log(pathname);
		
		var header = {};
		if     (pathname.indexOf(".html") >= 0)  header["Content-Type"] = "text/html";
		else if(pathname.indexOf(".css")  >= 0)  header["Content-Type"] = "text/css";
		else if(pathname.indexOf(".js")   >= 0)  header["Content-Type"] = "text/javascript";
		else                                     header["Content-Type"] = "text/plain";
		
		fs.stat(pathname, function(err, stat) {
			if(err){
				res.writeHead(500, {"Content-Type": "text/plain"});
				res.write(err + "\n\n");
				res.end();
				return;
			}
			if(stat.isDirectory()){
				res.writeHead(500, {"Content-Type": "text/plain"});
				res.write("Error: cannot read directory.\n\n");
				res.end();
				return;
			}
			
			var total = stat.size;
			if(typeof req.headers.range !== 'undefined'){
				var range = req.headers.range;
				var parts = range.replace(/bytes=/, "").split("-");
				var partialstart = parts[0];
				var partialend = parts[1];

				var start = parseInt(partialstart, 10);
				var end = partialend ? parseInt(partialend, 10) : total-1;
				var chunksize = (end-start)+1;
				
				header["Content-Range"] = "bytes " + start + "-" + end + "/" + total;
				header["Accept-Ranges"] = "bytes";
				header["Content-Length"]= chunksize;
				
				res.writeHead(206, header);
				
				var stream = fs.createReadStream(pathname, {start: start, end: end});
				stream.pipe(res);
			}
			else{
				header["Content-Length"] = total;
				
				res.writeHead(200, header);
				
				var stream = fs.createReadStream(pathname);
				stream.pipe(res);
			}
		});
	}
	else if(req.method == "POST"){
		var postName = decodeURIComponent(url.parse(req.url).pathname);		
		if(postName in this.postFuncs){
			this.postFuncs[postName](req, res);
		}
	}
};

httpserver.prototype.httpGET = function(name, callback) {
	this.getFuncs[name] = callback;
};

httpserver.prototype.httpPOST = function(name, callback) {
	this.postFuncs[name] = callback;
};

module.exports = httpserver;
